<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆå†…åµŒå®¢æœ</title>
    <link href="/static/css/tailwind.css" rel="stylesheet">
    <link href="/static/font-awesome/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#00B42A',
                        neutral: '#F5F7FA',
                        dark: '#1D2129',
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .message-appear {
                animation: fadeIn 0.3s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }
    </style>
</head>
<body class="font-inter bg-transparent min-h-screen m-0 p-0 overflow-hidden">
    <!-- å®¢æœæŒ‰é’® -->
    <div id="chat-button" class="fixed bottom-6 right-6 z-50">
        <button class="bg-primary hover:bg-primary/90 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-all duration-300 transform hover:scale-110">
            <i class="fa fa-comments text-xl"></i>
        </button>
    </div>
    
    <!-- å®¢æœçª—å£ (é»˜è®¤éšè—) -->
    <div id="chat-window" class="fixed bottom-6 right-6 w-[340px] max-w-full bg-white rounded-xl shadow-xl overflow-hidden transform translate-y-full transition-transform duration-300 ease-in-out z-50">
        <!-- çª—å£å¤´éƒ¨ -->
        <div class="bg-primary text-white p-4 flex items-center justify-between cursor-move" id="chat-header">
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center mr-2">
                    <i class="fa fa-comments text-white"></i>
                </div>
                <div>
                    <h3 class="font-bold">æ¸¸æˆå®¢æœ</h3>
                    <p class="text-xs opacity-80">åœ¨çº¿æ—¶é—´: 9:00-22:00</p>
                </div>
            </div>
            <div class="flex">
                <button id="minimize-chat" class="text-white/80 hover:text-white p-1">
                    <i class="fa fa-window-minimize"></i>
                </button>
                <button id="close-chat" class="text-white/80 hover:text-white p-1 ml-2">
                    <i class="fa fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- æ¬¢è¿åŒºåŸŸ -->
        <div id="embed-welcome-area" class="p-4 text-center">
            <h4 class="text-lg font-bold text-primary mb-2">éœ€è¦å¸®åŠ©ï¼Ÿ</h4>
            <p class="text-gray-600 text-sm mb-3">æˆ‘ä»¬çš„å®¢æœå›¢é˜Ÿéšæ—¶ä¸ºæ‚¨æœåŠ¡</p>
            <button id="start-embed-chat" class="bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-full text-sm transition-all duration-300 shadow-sm hover:shadow-md">
                å¼€å§‹å’¨è¯¢
            </button>
        </div>
        
        <!-- èŠå¤©åŒºåŸŸ (é»˜è®¤éšè—) -->
        <div id="embed-chat-area" class="hidden flex flex-col h-[400px]">
            <!-- å¸¸è§é—®é¢˜ -->
            <div class="p-3 bg-neutral border-b">
                <div class="text-xs text-gray-500 mb-1">å¸¸è§é—®é¢˜:</div>
                <div class="flex flex-wrap gap-1" id="embed-faq-container">
                    <!-- FAQ å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            
            <!-- æ¶ˆæ¯åŒºåŸŸ -->
            <div id="embed-messages-container" class="flex-1 overflow-y-auto p-3 space-y-3 scrollbar-hide">
                <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
            
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="p-3 border-t">
                <div class="flex items-center mb-1">
                    <button id="embed-emoji-btn" class="text-gray-500 hover:text-primary p-1">
                        <i class="fa fa-smile-o"></i>
                    </button>
                    <button id="embed-image-btn" class="text-gray-500 hover:text-primary p-1">
                        <i class="fa fa-picture-o"></i>
                    </button>
                    <div class="flex-1"></div>
                    <select id="embed-language-select" class="text-xs border rounded px-1 py-0 bg-white focus:outline-none focus:ring-1 focus:ring-primary">
                        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                        <option value="en-US">English</option>
                        <option value="ja-JP">æ—¥æœ¬èª</option>
                        <option value="ko-KR">í•œêµ­ì–´</option>
                    </select>
                </div>
                <div class="flex">
                    <textarea id="embed-message-input" class="flex-1 border rounded-l-lg p-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary resize-none" rows="1" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."></textarea>
                    <button id="embed-send-btn" class="bg-primary hover:bg-primary/90 text-white px-3 rounded-r-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                        å‘é€
                    </button>
                </div>
                <input type="file" id="embed-image-upload" class="hidden" accept="image/*">
            </div>
        </div>
    </div>
    
    <!-- Emojié€‰æ‹©å™¨ (é»˜è®¤éšè—) -->
    <div id="embed-emoji-picker" class="fixed bottom-[220px] right-[360px] bg-white rounded-lg shadow-xl p-2 w-48 hidden z-50">
        <div class="grid grid-cols-8 gap-1">
            <!-- Emojiå°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–DOMå…ƒç´ 
            const chatButton = document.getElementById('chat-button');
            const chatWindow = document.getElementById('chat-window');
            const minimizeChat = document.getElementById('minimize-chat');
            const closeChat = document.getElementById('close-chat');
            const chatHeader = document.getElementById('chat-header');
            const embedWelcomeArea = document.getElementById('embed-welcome-area');
            const embedChatArea = document.getElementById('embed-chat-area');
            const startEmbedChat = document.getElementById('start-embed-chat');
            const embedMessageInput = document.getElementById('embed-message-input');
            const embedSendBtn = document.getElementById('embed-send-btn');
            const embedMessagesContainer = document.getElementById('embed-messages-container');
            const embedEmojiBtn = document.getElementById('embed-emoji-btn');
            const embedEmojiPicker = document.getElementById('embed-emoji-picker');
            const embedImageBtn = document.getElementById('embed-image-btn');
            const embedImageUpload = document.getElementById('embed-image-upload');
            const embedFaqContainer = document.getElementById('embed-faq-container');
            const embedLanguageSelect = document.getElementById('embed-language-select');
            
            // ä¼šè¯ID
            let embedSessionId = null;
            // å›¾ç‰‡é¢„è§ˆåˆ—è¡¨
            let embedImagePreviews = [];
            // çª—å£æ‹–åŠ¨ç›¸å…³å˜é‡
            let isDragging = false;
            let offsetX, offsetY;
            
            // åˆå§‹åŒ–å¸¸è§é—®é¢˜
            initEmbedFAQs();
            
            // èŠå¤©æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            chatButton.addEventListener('click', function() {
                chatWindow.classList.remove('translate-y-full');
                chatButton.classList.add('hidden');
            });
            
            // æœ€å°åŒ–æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            minimizeChat.addEventListener('click', function() {
                chatWindow.classList.add('translate-y-full');
                chatButton.classList.remove('hidden');
            });
            
            // å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            closeChat.addEventListener('click', function() {
                chatWindow.classList.add('translate-y-full');
                chatButton.classList.remove('hidden');
                embedChatArea.classList.add('hidden');
                embedWelcomeArea.classList.remove('hidden');
            });
            
            // å¼€å§‹èŠå¤©æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            startEmbedChat.addEventListener('click', function() {
                embedWelcomeArea.classList.add('hidden');
                embedChatArea.classList.remove('hidden');
                
                // åˆ›å»ºæ–°ä¼šè¯
                createEmbedSession();
            });
            
            // æ¶ˆæ¯è¾“å…¥æ¡†äº‹ä»¶
            embedMessageInput.addEventListener('input', function() {
                embedSendBtn.disabled = this.value.trim() === '';
            });
            
            // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            embedSendBtn.addEventListener('click', sendEmbedMessage);
            
            // æ¶ˆæ¯è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            embedMessageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendEmbedMessage();
                }
            });
            
            // EmojiæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            embedEmojiBtn.addEventListener('click', function() {
                embedEmojiPicker.classList.toggle('hidden');
                
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ‰“å¼€ï¼ŒåŠ è½½Emoji
                if (embedEmojiPicker.querySelector('div').children.length === 0) {
                    loadEmbedEmojis();
                }
            });
            
            // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­Emojié€‰æ‹©å™¨
            document.addEventListener('click', function(e) {
                if (!embedEmojiBtn.contains(e.target) && !embedEmojiPicker.contains(e.target)) {
                    embedEmojiPicker.classList.add('hidden');
                }
            });
            
            // å›¾ç‰‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            embedImageBtn.addEventListener('click', function() {
                embedImageUpload.click();
            });
            
            // å›¾ç‰‡ä¸Šä¼ äº‹ä»¶
            embedImageUpload.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    
                    if (!embedSessionId) {
                        alert('è¯·å…ˆå¼€å§‹ä¼šè¯');
                        return;
                    }
                    
                    // åˆ›å»ºè¡¨å•æ•°æ®
                    const formData = new FormData();
                    formData.append('sessionId', embedSessionId);
                    formData.append('content', '');
                    formData.append('image', file);
                    formData.append('language', embedLanguageSelect.value);
                    
                    // å‘é€æ¶ˆæ¯
                    sendEmbedMessage(formData);
                    
                    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                    embedImageUpload.value = '';
                }
            });
            
            // è¯­è¨€é€‰æ‹©å˜åŒ–äº‹ä»¶
            embedLanguageSelect.addEventListener('change', function() {
                // ä¿å­˜ç”¨æˆ·è¯­è¨€è®¾ç½®
                localStorage.setItem('embedUserLanguage', this.value);
                
                // å¦‚æœå·²ç»æœ‰ä¼šè¯ï¼Œé‡æ–°åŠ è½½æ¶ˆæ¯ä»¥è·å–ç¿»è¯‘
                if (embedSessionId) {
                    loadEmbedMessages();
                }
            });
            
            // åˆå§‹åŒ–ç”¨æˆ·è¯­è¨€è®¾ç½®
            const savedEmbedLanguage = localStorage.getItem('embedUserLanguage');
            if (savedEmbedLanguage) {
                embedLanguageSelect.value = savedEmbedLanguage;
            }
            
            // çª—å£æ‹–åŠ¨åŠŸèƒ½
            chatHeader.addEventListener('mousedown', function(e) {
                isDragging = true;
                offsetX = e.clientX - chatWindow.getBoundingClientRect().left;
                offsetY = e.clientY - chatWindow.getBoundingClientRect().top;
                chatWindow.style.transition = 'none';
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const x = e.clientX - offsetX;
                const y = e.clientY - offsetY;
                
                // é™åˆ¶çª—å£ä½ç½®ï¼Œé˜²æ­¢å®Œå…¨ç§»å‡ºè§†å£
                const maxX = window.innerWidth - chatWindow.offsetWidth;
                const maxY = window.innerHeight - chatWindow.offsetHeight;
                
                chatWindow.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
                chatWindow.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
                chatWindow.style.bottom = 'auto';
                chatWindow.style.right = 'auto';
            });
            
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    chatWindow.style.transition = 'transform 0.3s ease-in-out';
                }
            });
            
            // åŠ è½½Emoji
            function loadEmbedEmojis() {
                const emojis = [
                    'ğŸ˜Š', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ¥°', 'ğŸ˜', 
                    'ğŸ¤©', 'ğŸ˜', 'ğŸ¤“', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 
                    'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥º', 
                    'ğŸ˜“', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤­', 'ğŸ§', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ™„', 'ğŸ˜´'
                ];
                
                const container = embedEmojiPicker.querySelector('div');
                
                emojis.forEach(emoji => {
                    const emojiBtn = document.createElement('button');
                    emojiBtn.className = 'text-base p-1 hover:bg-gray-100 rounded-full transition-colors';
                    emojiBtn.textContent = emoji;
                    
                    emojiBtn.addEventListener('click', function() {
                        embedMessageInput.value += emoji;
                        embedMessageInput.focus();
                        embedSendBtn.disabled = false;
                    });
                    
                    container.appendChild(emojiBtn);
                });
            }
            
            // åˆå§‹åŒ–å¸¸è§é—®é¢˜
            function initEmbedFAQs() {
                fetch('/api/faqs')
                    .then(response => response.json())
                    .then(faqs => {
                        embedFaqContainer.innerHTML = '';
                        
                        faqs.slice(0, 5).forEach(faq => {
                            const faqBtn = document.createElement('button');
                            faqBtn.className = 'bg-white hover:bg-primary hover:text-white text-xs border border-gray-200 hover:border-primary rounded-full px-2 py-0.5 transition-colors';
                            faqBtn.textContent = faq.Question;
                            
                            faqBtn.addEventListener('click', function() {
                                // å°†FAQçš„ç­”æ¡ˆæ·»åŠ åˆ°æ¶ˆæ¯æ¡†
                                addEmbedSystemMessage(faq.Answer);
                            });
                            
                            embedFaqContainer.appendChild(faqBtn);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading FAQs:', error);
                    });
            }
            
            // åˆ›å»ºä¼šè¯
            function createEmbedSession() {
                // ä»URLå‚æ•°è·å–æ¸¸æˆIDå’Œç©å®¶ID
                const urlParams = new URLSearchParams(window.location.search);
                const gameId = urlParams.get('gameId') || 'default_game';
                const playerId = urlParams.get('playerId') || `player_${Date.now()}`;
                const userLanguage = embedLanguageSelect.value;
                
                // ä¿å­˜é¢å¤–å‚æ•°
                const customFields = {
                    gameId: gameId,
                    playerId: playerId
                };
                
                // ä¿å­˜å…¶ä»–å¯èƒ½çš„URLå‚æ•°
                urlParams.forEach((value, key) => {
                    if (key !== 'gameId' && key !== 'playerId') {
                        customFields[key] = value;
                    }
                });
                
                // å‘é€APIè¯·æ±‚åˆ›å»ºä¼šè¯
                fetch('/api/session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userID: playerId,
                        language: userLanguage,
                        customFields: JSON.stringify(customFields)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    embedSessionId = data.id;
                    
                    // è¿æ¥WebSocket
                    connectEmbedWebSocket();
                    
                    // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                    addEmbedSystemMessage('æ‚¨å¥½ï¼æ¬¢è¿ä½¿ç”¨æ¸¸æˆå®¢æœï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ');
                })
                .catch(error => {
                    console.error('Error creating session:', error);
                    addEmbedSystemMessage('åˆ›å»ºä¼šè¯å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
            
            // å‘é€æ¶ˆæ¯
            function sendEmbedMessage(formData = null) {
                if (!formData) {
                    const content = embedMessageInput.value.trim();
                    const userLanguage = embedLanguageSelect.value;
                    
                    if (!embedSessionId || content === '') {
                        return;
                    }
                    
                    // åˆ›å»ºè¡¨å•æ•°æ®
                    formData = new FormData();
                    formData.append('sessionId', embedSessionId);
                    formData.append('content', content);
                    formData.append('language', userLanguage);
                }
                
                // æ˜¾ç¤ºæ­£åœ¨å‘é€çš„æ¶ˆæ¯
                const content = formData.get('content');
                const isImage = formData.get('image') !== null;
                
                if (content || isImage) {
                    const messageId = addEmbedMessage(
                        content, 
                        'outgoing', 
                        isImage ? [URL.createObjectURL(formData.get('image'))] : []
                    );
                }
                
                // å‘é€æ¶ˆæ¯
                fetch('/api/message', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Message sent successfully:', data);
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    if (!isImage) {
                        embedMessageInput.value = '';
                        embedSendBtn.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    
                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    const messageElement = document.getElementById(`embed-message-${messageId}`);
                    if (messageElement) {
                        messageElement.classList.add('text-red-500');
                        messageElement.innerHTML += '<span class="text-xs ml-2">(å‘é€å¤±è´¥)</span>';
                    }
                });
            }
            
            // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
            function addEmbedSystemMessage(content) {
                const messageElement = document.createElement('div');
                messageElement.className = 'flex justify-center message-appear';
                messageElement.innerHTML = `
                    <div class="bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full text-xs max-w-[70%]">
                        ${content}
                    </div>
                `;
                
                embedMessagesContainer.appendChild(messageElement);
                embedMessagesContainer.scrollTop = embedMessagesContainer.scrollHeight;
            }
            
            // æ·»åŠ æ¶ˆæ¯
            function addEmbedMessage(content, direction, images = []) {
                const messageId = Date.now().toString();
                
                const messageElement = document.createElement('div');
                messageElement.className = `flex ${direction === 'outgoing' ? 'justify-end' : 'justify-start'} message-appear`;
                messageElement.id = `embed-message-${messageId}`;
                
                let bubbleClass = direction === 'outgoing' ? 'bg-primary text-white' : 'bg-white border border-gray-200 text-gray-800';
                
                let messageContent = '';
                
                if (content) {
                    messageContent += `<div class="text-xs mb-1">${content}</div>`;
                }
                
                if (images && images.length > 0) {
                    messageContent += `<div class="flex gap-1 mb-1">${images.map(img => `<img src="${img}" class="w-16 h-16 object-cover rounded border" />`).join('')}</div>`;
                }
                
                // ç¿»è¯‘å†…å®¹å ä½
                messageContent += `<div class="text-[10px] mt-0.5 text-gray-400 translate-placeholder">æ­£åœ¨ç¿»è¯‘...</div>`;
                
                messageElement.innerHTML = `
                    <div class="max-w-[70%]">
                        <div class="${bubbleClass} p-2 rounded-lg">
                            ${messageContent}
                        </div>
                    </div>
                `;
                
                embedMessagesContainer.appendChild(messageElement);
                embedMessagesContainer.scrollTop = embedMessagesContainer.scrollHeight;
                
                return messageId;
            }
            
            // è¿æ¥WebSocket
            function connectEmbedWebSocket() {
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws?sessionId=${embedSessionId}`;
                
                const ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    console.log('Embed WebSocket connection established');
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'message') {
                        // æ·»åŠ æ”¶åˆ°çš„æ¶ˆæ¯
                        addEmbedMessage(data.content, 'incoming', data.images || []);
                        
                        // æ›´æ–°ç¿»è¯‘å†…å®¹
                        updateEmbedTranslation(data.id, data.translatedContent);
                    } else if (data.type === 'system') {
                        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
                        addEmbedSystemMessage(data.content);
                    }
                };
                
                ws.onclose = function() {
                    console.log('Embed WebSocket connection closed');
                    // å¯ä»¥æ·»åŠ é‡è¿é€»è¾‘
                };
                
                ws.onerror = function(error) {
                    console.error('Embed WebSocket error:', error);
                };
            }
            
            // æ›´æ–°ç¿»è¯‘å†…å®¹
            function updateEmbedTranslation(messageId, translatedContent) {
                const messageElement = document.getElementById(`embed-message-${messageId}`);
                if (messageElement) {
                    const translatePlaceholder = messageElement.querySelector('.translate-placeholder');
                    if (translatePlaceholder) {
                        translatePlaceholder.textContent = translatedContent || 'ç¿»è¯‘å¤±è´¥';
                    }
                }
            }
        });
    </script>
</body>
</html>    